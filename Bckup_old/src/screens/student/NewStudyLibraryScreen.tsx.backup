/**
 * NewStudyLibraryScreen - Premium Minimal Design
 * Purpose: Digital resource browser with search, offline download, and note-taking
 * Features: Search, Filter, Sort, Download, Bookmarks, Notes, View Toggle, Caching
 */

import React, { useState, useCallback, useMemo, useEffect } from 'react';
import {
  View,
  StyleSheet,
  TouchableOpacity,
  FlatList,
  Linking,
  Alert,
  TextInput,
  Modal,
  ScrollView,
  Dimensions,
} from 'react-native';
import { useQuery, useMutation } from '@tanstack/react-query';
import { NativeStackScreenProps } from '@react-navigation/native-stack';
import { BaseScreen } from '../../shared/components/BaseScreen';
import { Card, CardHeader, CardContent, CardActions, T, Button, Chip, Badge, Row, Col, Spacer } from '../../ui';
import { trackAction, trackScreenView } from '../../utils/navigationAnalytics';
import { useAuth } from '../../context/AuthContext';
import { supabase } from '../../config/supabaseClient';
import AsyncStorage from '@react-native-async-storage/async-storage';

const { width } = Dimensions.get('window');

type Props = NativeStackScreenProps<any, 'NewStudyLibraryScreen'>;

interface StudyMaterial {
  id: string;
  title: string;
  subject: string;
  type: 'pdf' | 'video' | 'document' | 'link' | 'audio' | 'presentation' | 'image';
  file_url?: string;
  description?: string;
  created_at: string;
  author?: string;
  tags?: string[];
  rating?: number;
  downloads?: number;
  file_size?: string;
  isBookmarked?: boolean;
  isDownloaded?: boolean;
  downloadProgress?: number;
}

interface Note {
  id: string;
  material_id: string;
  content: string;
  created_at: string;
}

type ViewMode = 'grid' | 'list';
type FilterType = 'all' | 'bookmarked' | 'downloaded' | 'recent';
type SortType = 'name' | 'date' | 'size' | 'rating';

export default function NewStudyLibraryScreen({ navigation }: Props) {
  const { user } = useAuth();

  // State management
  const [selectedSubject, setSelectedSubject] = useState<string>('All');
  const [searchQuery, setSearchQuery] = useState('');
  const [filterType, setFilterType] = useState<FilterType>('all');
  const [sortType, setSortType] = useState<SortType>('date');
  const [viewMode, setViewMode] = useState<ViewMode>('list');
  const [showSortModal, setShowSortModal] = useState(false);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [showNoteModal, setShowNoteModal] = useState(false);
  const [selectedMaterial, setSelectedMaterial] = useState<StudyMaterial | null>(null);
  const [noteText, setNoteText] = useState('');
  const [notes, setNotes] = useState<Note[]>([]);

  // Track screen view
  useEffect(() => {
    trackScreenView('NewStudyLibraryScreen');
    loadCachedData();
    loadNotes();
  }, []);

  // Fetch study materials
  const { data: materials, isLoading, error, refetch, isRefetching } = useQuery({
    queryKey: ['study-materials', user?.id],
    queryFn: async () => {
      if (!user?.id) throw new Error('No user ID');

      const { data, error } = await supabase
        .from('study_materials')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;

      // Load bookmark status
      const { data: bookmarks } = await supabase
        .from('user_bookmarks')
        .select('material_id')
        .eq('user_id', user.id);

      const bookmarkedIds = new Set(bookmarks?.map(b => b.material_id) || []);

      const materialsWithStatus = (data || []).map(m => ({
        ...m,
        isBookmarked: bookmarkedIds.has(m.id),
        isDownloaded: false, // Check local storage if needed
      })) as StudyMaterial[];

      // Cache data
      await AsyncStorage.setItem('study_materials_cache', JSON.stringify({
        materials: materialsWithStatus,
        timestamp: Date.now(),
      }));

      return materialsWithStatus;
    },
    enabled: !!user?.id,
  });

  // Load cached data on mount
  const loadCachedData = async () => {
    try {
      const cached = await AsyncStorage.getItem('study_materials_cache');
      if (cached) {
        console.log('Loaded materials from cache');
      }
    } catch (error) {
      console.error('Failed to load cache:', error);
    }
  };

  // Load notes
  const loadNotes = async () => {
    if (!user?.id) return;
    try {
      const { data } = await supabase
        .from('material_notes')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (data) {
        setNotes(data);
      }
    } catch (error) {
      console.error('Failed to load notes:', error);
    }
  };

  // Get unique subjects
  const subjects = useMemo(() => {
    if (!materials) return ['All'];
    const uniqueSubjects = Array.from(new Set(materials.map(m => m.subject)));
    return ['All', ...uniqueSubjects];
  }, [materials]);

  // Filter, search, and sort materials
  const filteredMaterials = useMemo(() => {
    if (!materials) return [];
    let filtered = materials;

    // Apply search filter
    if (searchQuery) {
      filtered = filtered.filter(m =>
        m.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.description?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.author?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.tags?.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()))
      );
    }

    // Apply subject filter
    if (selectedSubject !== 'All') {
      filtered = filtered.filter(m => m.subject === selectedSubject);
    }

    // Apply type filter
    switch (filterType) {
      case 'bookmarked':
        filtered = filtered.filter(m => m.isBookmarked);
        break;
      case 'downloaded':
        filtered = filtered.filter(m => m.isDownloaded);
        break;
      case 'recent':
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        filtered = filtered.filter(m => new Date(m.created_at) > weekAgo);
        break;
    }

    // Apply sorting
    const sorted = [...filtered].sort((a, b) => {
      switch (sortType) {
        case 'name':
          return a.title.localeCompare(b.title);
        case 'date':
          return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
        case 'size':
          return parseFloat(b.file_size || '0') - parseFloat(a.file_size || '0');
        case 'rating':
          return (b.rating || 0) - (a.rating || 0);
        default:
          return 0;
      }
    });

    return sorted;
  }, [materials, searchQuery, selectedSubject, filterType, sortType]);

  // Get material icon
  const getMaterialIcon = (type: string): string => {
    switch (type) {
      case 'pdf':
        return 'üìÑ';
      case 'video':
        return 'üé•';
      case 'audio':
        return 'üéµ';
      case 'presentation':
        return 'üìä';
      case 'image':
        return 'üñºÔ∏è';
      case 'link':
        return 'üîó';
      default:
        return 'üìù';
    }
  };

  // Toggle bookmark
  const toggleBookmark = useCallback(async (materialId: string) => {
    if (!user?.id) return;

    const material = materials?.find(m => m.id === materialId);
    const isCurrentlyBookmarked = material?.isBookmarked;

    try {
      if (isCurrentlyBookmarked) {
        await supabase
          .from('user_bookmarks')
          .delete()
          .match({ user_id: user.id, material_id: materialId });
      } else {
        await supabase
          .from('user_bookmarks')
          .insert({ user_id: user.id, material_id: materialId });
      }

      trackAction('toggle_bookmark', 'NewStudyLibraryScreen', {
        materialId,
        bookmarked: !isCurrentlyBookmarked
      });

      refetch();
      Alert.alert(
        'Success',
        isCurrentlyBookmarked ? 'Removed from bookmarks' : 'Added to bookmarks'
      );
    } catch (error) {
      Alert.alert('Error', 'Failed to update bookmark');
    }
  }, [materials, user?.id, refetch]);

  // Download resource (simulated)
  const downloadResource = useCallback(async (materialId: string) => {
    const material = materials?.find(m => m.id === materialId);
    if (!material) return;

    Alert.alert(
      'Download',
      `Download "${material.title}"?\n\nThis will save the file for offline access.`,
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Download',
          onPress: () => {
            trackAction('download_material', 'NewStudyLibraryScreen', { materialId });
            // Simulate download - in production, use FileSystem API
            Alert.alert('Downloading', 'File download started...');
          },
        },
      ]
    );
  }, [materials]);

  // View material detail
  const viewMaterialDetail = useCallback((material: StudyMaterial) => {
    setSelectedMaterial(material);
    setShowDetailModal(true);
    trackAction('view_material_detail', 'NewStudyLibraryScreen', { materialId: material.id });
  }, []);

  // Open file
  const handleMaterialPress = useCallback(async (material: StudyMaterial) => {
    if (!material.file_url) {
      Alert.alert('No File', 'This material does not have a file attached.');
      return;
    }

    trackAction('open_study_material', 'NewStudyLibraryScreen', {
      materialId: material.id,
      type: material.type,
    });

    try {
      const supported = await Linking.canOpenURL(material.file_url);
      if (supported) {
        await Linking.openURL(material.file_url);
      } else {
        Alert.alert('Error', 'Unable to open this file.');
      }
    } catch (err) {
      Alert.alert('Error', 'Failed to open file.');
    }
  }, []);

  // Add note
  const openNoteModal = useCallback((materialId: string) => {
    const material = materials?.find(m => m.id === materialId);
    setSelectedMaterial(material || null);
    setNoteText('');
    setShowNoteModal(true);
  }, [materials]);

  // Save note
  const saveNote = useCallback(async () => {
    if (!noteText.trim() || !selectedMaterial || !user?.id) return;

    try {
      const { error } = await supabase
        .from('material_notes')
        .insert({
          user_id: user.id,
          material_id: selectedMaterial.id,
          content: noteText.trim(),
        });

      if (error) throw error;

      trackAction('add_note', 'NewStudyLibraryScreen', { materialId: selectedMaterial.id });
      setShowNoteModal(false);
      setNoteText('');
      loadNotes();
      Alert.alert('Success', 'Note added successfully!');
    } catch (error) {
      Alert.alert('Error', 'Failed to save note');
    }
  }, [noteText, selectedMaterial, user?.id]);

  // Render material card (List view)
  const renderMaterialList = ({ item }: { item: StudyMaterial }) => (
    <Card style={styles.materialCard} onPress={() => viewMaterialDetail(item)}>
      <View style={styles.materialContent}>
        <View style={styles.materialIcon}>
          <T variant="h3">{getMaterialIcon(item.type)}</T>
        </View>

        <View style={styles.materialInfo}>
          <Row justify="space-between" align="flex-start">
            <View style={{ flex: 1 }}>
              <T variant="body" weight="semiBold" numberOfLines={2}>
                {item.title}
              </T>
            </View>
            <TouchableOpacity
              onPress={(e) => {
                e.stopPropagation();
                toggleBookmark(item.id);
              }}
              style={styles.bookmarkButton}
              accessibilityRole="button"
              accessibilityLabel={item.isBookmarked ? 'Remove bookmark' : 'Add bookmark'}
            >
              <T variant="h3">{item.isBookmarked ? '‚≠ê' : '‚òÜ'}</T>
            </TouchableOpacity>
          </Row>

          <Badge variant="info" style={styles.subjectBadge}>
            {item.subject}
          </Badge>

          {item.description && (
            <T variant="caption" style={styles.materialDescription} numberOfLines={2}>
              {item.description}
            </T>
          )}

          {item.author && (
            <T variant="caption" style={styles.authorText}>
              üë§ {item.author}
            </T>
          )}

          <Row gap="md" style={styles.statsRow}>
            {item.rating !== undefined && item.rating > 0 && (
              <Row gap="xs">
                <T variant="caption">‚≠ê</T>
                <T variant="caption">{item.rating.toFixed(1)}</T>
              </Row>
            )}
            {item.downloads !== undefined && item.downloads > 0 && (
              <Row gap="xs">
                <T variant="caption">‚¨áÔ∏è</T>
                <T variant="caption">{item.downloads}</T>
              </Row>
            )}
            {item.file_size && (
              <T variant="caption">üìè {item.file_size}</T>
            )}
            <T variant="caption" style={styles.dateText}>
              {new Date(item.created_at).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
              })}
            </T>
          </Row>

          {item.tags && item.tags.length > 0 && (
            <Row gap="xs" wrap style={{ marginTop: 4 }}>
              {item.tags.slice(0, 3).map((tag, index) => (
                <Chip key={`${item.id}-tag-${index}`} variant="suggestion" label={`#${tag}`} />
              ))}
            </Row>
          )}
        </View>
      </View>
    </Card>
  );

  // Render material card (Grid view)
  const renderMaterialGrid = ({ item }: { item: StudyMaterial }) => (
    <Card style={styles.gridCard} onPress={() => viewMaterialDetail(item)}>
      <View style={styles.gridContent}>
        <Row justify="space-between" align="flex-start">
          <T variant="h1">{getMaterialIcon(item.type)}</T>
          <TouchableOpacity
            onPress={(e) => {
              e.stopPropagation();
              toggleBookmark(item.id);
            }}
            accessibilityRole="button"
            accessibilityLabel={item.isBookmarked ? 'Remove bookmark' : 'Add bookmark'}
          >
            <T variant="h3">{item.isBookmarked ? '‚≠ê' : '‚òÜ'}</T>
          </TouchableOpacity>
        </Row>

        <T variant="body" weight="semiBold" numberOfLines={2} style={{ marginTop: 8 }}>
          {item.title}
        </T>

        <Badge variant="info" style={{ marginTop: 4, alignSelf: 'flex-start' }}>
          {item.subject}
        </Badge>

        {item.rating !== undefined && item.rating > 0 && (
          <Row gap="xs" style={{ marginTop: 8 }}>
            <T variant="caption">‚≠ê</T>
            <T variant="caption">{item.rating.toFixed(1)}</T>
          </Row>
        )}
      </View>
    </Card>
  );

  return (
    <BaseScreen
      scrollable={false}
      loading={isLoading}
      error={error ? 'Failed to load study materials' : null}
      empty={!materials || materials.length === 0}
      emptyMessage="No study materials available"
      emptyIcon="üìö"
      onRefresh={refetch}
      refreshing={isRefetching}
    >
      <View style={styles.container}>
        {/* Search Bar */}
        <Card variant="outlined" style={styles.searchCard}>
          <Row gap="sm" align="center">
            <T variant="h3">üîç</T>
            <TextInput
              style={styles.searchInput}
              placeholder="Search resources, authors, tags..."
              value={searchQuery}
              onChangeText={setSearchQuery}
              placeholderTextColor="#9CA3AF"
            />
            {searchQuery.length > 0 && (
              <TouchableOpacity onPress={() => setSearchQuery('')}>
                <T variant="body" style={{ color: '#6B7280' }}>‚úï</T>
              </TouchableOpacity>
            )}
          </Row>
        </Card>

        {/* Filter and Sort Controls */}
        <Card variant="outlined" style={styles.controlsCard}>
          <T variant="body" weight="semiBold" style={{ marginBottom: 8 }}>
            Filter:
          </T>
          <ScrollView horizontal showsHorizontalScrollIndicator={false}>
            <Row gap="xs">
              <Chip
                variant="filter"
                label="All"
                selected={filterType === 'all'}
                onPress={() => {
                  setFilterType('all');
                  trackAction('filter_change', 'NewStudyLibraryScreen', { filter: 'all' });
                }}
              />
              <Chip
                variant="filter"
                label="‚≠ê Bookmarked"
                selected={filterType === 'bookmarked'}
                onPress={() => {
                  setFilterType('bookmarked');
                  trackAction('filter_change', 'NewStudyLibraryScreen', { filter: 'bookmarked' });
                }}
              />
              <Chip
                variant="filter"
                label="‚¨áÔ∏è Downloaded"
                selected={filterType === 'downloaded'}
                onPress={() => {
                  setFilterType('downloaded');
                  trackAction('filter_change', 'NewStudyLibraryScreen', { filter: 'downloaded' });
                }}
              />
              <Chip
                variant="filter"
                label="üÜï Recent"
                selected={filterType === 'recent'}
                onPress={() => {
                  setFilterType('recent');
                  trackAction('filter_change', 'NewStudyLibraryScreen', { filter: 'recent' });
                }}
              />
            </Row>
          </ScrollView>

          <Spacer size="md" />

          <Row justify="space-between" align="center">
            <View>
              <T variant="body" weight="semiBold" style={{ marginBottom: 8 }}>
                Subject:
              </T>
              <ScrollView horizontal showsHorizontalScrollIndicator={false}>
                <Row gap="xs">
                  {subjects.map(subject => (
                    <Chip
                      key={subject}
                      variant="filter"
                      label={subject}
                      selected={selectedSubject === subject}
                      onPress={() => {
                        setSelectedSubject(subject);
                        trackAction('filter_subject', 'NewStudyLibraryScreen', { subject });
                      }}
                    />
                  ))}
                </Row>
              </ScrollView>
            </View>
          </Row>

          <Spacer size="md" />

          <Row justify="space-between" align="center">
            <TouchableOpacity onPress={() => setShowSortModal(true)}>
              <Chip variant="assist" label={`Sort: ${sortType}`} />
            </TouchableOpacity>

            <Row gap="xs">
              <Chip
                variant="filter"
                label="‚äû"
                selected={viewMode === 'grid'}
                onPress={() => {
                  setViewMode('grid');
                  trackAction('view_mode', 'NewStudyLibraryScreen', { mode: 'grid' });
                }}
              />
              <Chip
                variant="filter"
                label="‚ò∞"
                selected={viewMode === 'list'}
                onPress={() => {
                  setViewMode('list');
                  trackAction('view_mode', 'NewStudyLibraryScreen', { mode: 'list' });
                }}
              />
            </Row>
          </Row>
        </Card>

        {/* Results Count */}
        <View style={styles.resultsCount}>
          <T variant="caption" style={{ color: '#6B7280' }}>
            {filteredMaterials.length} resource{filteredMaterials.length !== 1 ? 's' : ''} found
          </T>
        </View>

        {/* Materials List */}
        {viewMode === 'list' ? (
          <FlatList
            data={filteredMaterials}
            keyExtractor={(item) => item.id}
            renderItem={renderMaterialList}
            contentContainerStyle={styles.materialsList}
            showsVerticalScrollIndicator={false}
            ListEmptyComponent={
              <View style={styles.emptyContainer}>
                <T variant="body" style={styles.emptyText}>
                  {searchQuery
                    ? `No results for "${searchQuery}"`
                    : selectedSubject !== 'All'
                    ? `No materials for ${selectedSubject}`
                    : filterType !== 'all'
                    ? `No ${filterType} materials`
                    : 'No study materials available'}
                </T>
              </View>
            }
          />
        ) : (
          <FlatList
            data={filteredMaterials}
            keyExtractor={(item) => item.id}
            renderItem={renderMaterialGrid}
            numColumns={2}
            columnWrapperStyle={styles.gridRow}
            contentContainerStyle={styles.materialsList}
            showsVerticalScrollIndicator={false}
            ListEmptyComponent={
              <View style={styles.emptyContainer}>
                <T variant="body" style={styles.emptyText}>
                  No materials found
                </T>
              </View>
            }
          />
        )}

        {/* Sort Modal */}
        <Modal visible={showSortModal} transparent animationType="slide">
          <View style={styles.modalOverlay}>
            <Card style={styles.sortModal}>
              <CardHeader
                title="Sort By"
                trailing={
                  <TouchableOpacity onPress={() => setShowSortModal(false)}>
                    <T variant="h2">‚úï</T>
                  </TouchableOpacity>
                }
              />
              <CardContent>
                <Button
                  variant={sortType === 'date' ? 'primary' : 'ghost'}
                  fullWidth
                  onPress={() => {
                    setSortType('date');
                    setShowSortModal(false);
                    trackAction('sort_change', 'NewStudyLibraryScreen', { sort: 'date' });
                  }}
                >
                  üìÖ Date Added
                </Button>
                <Spacer size="sm" />
                <Button
                  variant={sortType === 'name' ? 'primary' : 'ghost'}
                  fullWidth
                  onPress={() => {
                    setSortType('name');
                    setShowSortModal(false);
                    trackAction('sort_change', 'NewStudyLibraryScreen', { sort: 'name' });
                  }}
                >
                  üî§ Name
                </Button>
                <Spacer size="sm" />
                <Button
                  variant={sortType === 'rating' ? 'primary' : 'ghost'}
                  fullWidth
                  onPress={() => {
                    setSortType('rating');
                    setShowSortModal(false);
                    trackAction('sort_change', 'NewStudyLibraryScreen', { sort: 'rating' });
                  }}
                >
                  ‚≠ê Rating
                </Button>
                <Spacer size="sm" />
                <Button
                  variant={sortType === 'size' ? 'primary' : 'ghost'}
                  fullWidth
                  onPress={() => {
                    setSortType('size');
                    setShowSortModal(false);
                    trackAction('sort_change', 'NewStudyLibraryScreen', { sort: 'size' });
                  }}
                >
                  üìè File Size
                </Button>
              </CardContent>
            </Card>
          </View>
        </Modal>

        {/* Detail Modal */}
        <Modal visible={showDetailModal} transparent animationType="slide">
          <View style={styles.modalOverlay}>
            <ScrollView contentContainerStyle={styles.scrollModalContent}>
              <Card style={styles.detailModal}>
                <CardHeader
                  title={selectedMaterial?.title || ''}
                  trailing={
                    <TouchableOpacity onPress={() => setShowDetailModal(false)}>
                      <T variant="h2">‚úï</T>
                    </TouchableOpacity>
                  }
                />
                <CardContent>
                  <Row gap="sm" style={{ marginBottom: 16 }}>
                    <T variant="h1">{getMaterialIcon(selectedMaterial?.type || 'document')}</T>
                    <Badge variant="info">{selectedMaterial?.type.toUpperCase()}</Badge>
                    <Badge>{selectedMaterial?.subject}</Badge>
                  </Row>

                  {selectedMaterial?.description && (
                    <>
                      <T variant="body" weight="semiBold">Description:</T>
                      <Spacer size="sm" />
                      <T variant="body">{selectedMaterial.description}</T>
                      <Spacer size="md" />
                    </>
                  )}

                  {selectedMaterial?.author && (
                    <>
                      <T variant="body" weight="semiBold">Author:</T>
                      <Spacer size="sm" />
                      <T variant="body">üë§ {selectedMaterial.author}</T>
                      <Spacer size="md" />
                    </>
                  )}

                  <Row gap="lg">
                    {selectedMaterial?.rating !== undefined && selectedMaterial.rating > 0 && (
                      <Col>
                        <T variant="caption" style={{ color: '#6B7280' }}>Rating</T>
                        <Row gap="xs">
                          <T variant="body">‚≠ê</T>
                          <T variant="body" weight="semiBold">{selectedMaterial.rating.toFixed(1)}</T>
                        </Row>
                      </Col>
                    )}
                    {selectedMaterial?.downloads !== undefined && selectedMaterial.downloads > 0 && (
                      <Col>
                        <T variant="caption" style={{ color: '#6B7280' }}>Downloads</T>
                        <Row gap="xs">
                          <T variant="body">‚¨áÔ∏è</T>
                          <T variant="body" weight="semiBold">{selectedMaterial.downloads}</T>
                        </Row>
                      </Col>
                    )}
                    {selectedMaterial?.file_size && (
                      <Col>
                        <T variant="caption" style={{ color: '#6B7280' }}>Size</T>
                        <T variant="body" weight="semiBold">üìè {selectedMaterial.file_size}</T>
                      </Col>
                    )}
                  </Row>

                  <Spacer size="md" />

                  <T variant="caption" style={{ color: '#9CA3AF' }}>
                    Added on {new Date(selectedMaterial?.created_at || '').toLocaleDateString()}
                  </T>

                  {selectedMaterial?.tags && selectedMaterial.tags.length > 0 && (
                    <>
                      <Spacer size="md" />
                      <T variant="body" weight="semiBold">Tags:</T>
                      <Spacer size="sm" />
                      <Row gap="xs" wrap>
                        {selectedMaterial.tags.map((tag, index) => (
                          <Chip key={`detail-tag-${index}`} variant="suggestion" label={`#${tag}`} />
                        ))}
                      </Row>
                    </>
                  )}
                </CardContent>
                <CardActions>
                  <Button
                    variant="outline"
                    onPress={() => {
                      setShowDetailModal(false);
                      openNoteModal(selectedMaterial?.id || '');
                    }}
                  >
                    üìù Add Note
                  </Button>
                  <Button
                    variant="outline"
                    onPress={() => {
                      if (selectedMaterial) {
                        downloadResource(selectedMaterial.id);
                      }
                    }}
                  >
                    ‚¨áÔ∏è Download
                  </Button>
                  <Button
                    variant="primary"
                    onPress={() => {
                      if (selectedMaterial) {
                        setShowDetailModal(false);
                        handleMaterialPress(selectedMaterial);
                      }
                    }}
                  >
                    Open File
                  </Button>
                </CardActions>
              </Card>
            </ScrollView>
          </View>
        </Modal>

        {/* Note Modal */}
        <Modal visible={showNoteModal} transparent animationType="slide">
          <View style={styles.modalOverlay}>
            <Card style={styles.noteModal}>
              <CardHeader
                title="Add Note"
                trailing={
                  <TouchableOpacity onPress={() => setShowNoteModal(false)}>
                    <T variant="h2">‚úï</T>
                  </TouchableOpacity>
                }
              />
              <CardContent>
                <T variant="body" style={{ marginBottom: 8 }}>
                  {selectedMaterial?.title}
                </T>
                <TextInput
                  style={styles.noteInput}
                  placeholder="Write your note..."
                  value={noteText}
                  onChangeText={setNoteText}
                  multiline
                  numberOfLines={6}
                  placeholderTextColor="#9CA3AF"
                />
              </CardContent>
              <CardActions>
                <Button variant="ghost" onPress={() => setShowNoteModal(false)}>
                  Cancel
                </Button>
                <Button variant="primary" onPress={saveNote}>
                  Save Note
                </Button>
              </CardActions>
            </Card>
          </View>
        </Modal>

        {/* My Notes Section (if any) */}
        {notes.length > 0 && (
          <View style={styles.notesSection}>
            <T variant="body" weight="semiBold" style={{ marginBottom: 8 }}>
              üìù My Notes ({notes.length})
            </T>
            {notes.slice(0, 3).map(note => {
              const material = materials?.find(m => m.id === note.material_id);
              return (
                <Card key={note.id} style={styles.noteCard}>
                  {material && (
                    <T variant="caption" weight="semiBold" style={{ color: '#3B82F6' }}>
                      {material.title}
                    </T>
                  )}
                  <T variant="body" style={{ marginTop: 4 }}>
                    {note.content}
                  </T>
                  <T variant="caption" style={{ color: '#9CA3AF', marginTop: 4 }}>
                    {new Date(note.created_at).toLocaleDateString()}
                  </T>
                </Card>
              );
            })}
          </View>
        )}
      </View>
    </BaseScreen>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  searchCard: {
    margin: 16,
    marginBottom: 8,
    padding: 12,
  },
  searchInput: {
    flex: 1,
    fontSize: 16,
    color: '#1F2937',
  },
  controlsCard: {
    marginHorizontal: 16,
    marginBottom: 8,
    padding: 12,
  },
  resultsCount: {
    paddingHorizontal: 16,
    paddingBottom: 8,
  },
  materialsList: {
    padding: 16,
    gap: 12,
  },
  materialCard: {
    marginBottom: 0,
  },
  materialContent: {
    flexDirection: 'row',
    gap: 12,
    padding: 12,
  },
  materialIcon: {
    width: 48,
    height: 48,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#F9FAFB',
    borderRadius: 12,
  },
  materialInfo: {
    flex: 1,
    gap: 4,
  },
  bookmarkButton: {
    marginLeft: 8,
  },
  subjectBadge: {
    alignSelf: 'flex-start',
  },
  materialDescription: {
    color: '#6B7280',
  },
  authorText: {
    color: '#6B7280',
  },
  statsRow: {
    marginTop: 4,
  },
  dateText: {
    color: '#9CA3AF',
  },
  gridRow: {
    gap: 12,
  },
  gridCard: {
    flex: 1,
    maxWidth: (width - 48) / 2,
  },
  gridContent: {
    padding: 12,
  },
  emptyContainer: {
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 48,
  },
  emptyText: {
    color: '#9CA3AF',
    fontStyle: 'italic',
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 16,
  },
  scrollModalContent: {
    flexGrow: 1,
    justifyContent: 'center',
    padding: 16,
  },
  sortModal: {
    width: '100%',
    maxWidth: 400,
  },
  detailModal: {
    width: '100%',
    maxWidth: 500,
  },
  noteModal: {
    width: '100%',
    maxWidth: 400,
  },
  noteInput: {
    borderWidth: 1,
    borderColor: '#E5E7EB',
    borderRadius: 8,
    padding: 12,
    fontSize: 16,
    minHeight: 120,
    textAlignVertical: 'top',
    color: '#1F2937',
  },
  notesSection: {
    padding: 16,
    paddingTop: 0,
  },
  noteCard: {
    marginBottom: 8,
    padding: 12,
  },
});
