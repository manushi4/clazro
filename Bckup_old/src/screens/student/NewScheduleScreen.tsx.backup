/**
 * NewScheduleScreen - Premium Minimal Design
 * Purpose: Display weekly/daily/monthly class schedule with advanced filtering
 * Features: View modes, filters, sorting, settings, caching
 */

import React, { useState, useCallback, useMemo, useEffect } from 'react';
import {
  View,
  StyleSheet,
  TouchableOpacity,
  FlatList,
  ScrollView,
  Modal,
  Alert,
  Switch,
  SafeAreaView,
} from 'react-native';
import { useQuery } from '@tanstack/react-query';
import { NativeStackScreenProps } from '@react-navigation/native-stack';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { BaseScreen } from '../../shared/components/BaseScreen';
import { T, Card, CardHeader, CardContent, CardActions, Button, Chip, Row, Col, Spacer, Badge } from '../../ui';
import { safeNavigate } from '../../utils/navigationService';
import { trackAction, trackScreenView } from '../../utils/navigationAnalytics';
import { useAuth } from '../../context/AuthContext';
import { supabase } from '../../config/supabaseClient';
import HamburgerMenu from './HamburgerMenu';

type Props = NativeStackScreenProps<any, 'NewScheduleScreen'>;

interface ClassSession {
  id: string;
  subject: string;
  teacher_name: string;
  scheduled_at: string;
  duration_minutes: number;
  meeting_link?: string;
  status: 'scheduled' | 'live' | 'completed' | 'cancelled';
  description?: string;
  priority?: 'low' | 'medium' | 'high';
  is_deadline?: boolean;
}

interface DaySchedule {
  date: Date;
  dayName: string;
  dayShort: string;
  isToday: boolean;
  classes: ClassSession[];
}

interface ScheduleSettings {
  showWeekends: boolean;
  showDeadlines: boolean;
  defaultView: 'week' | 'day' | 'month' | 'agenda';
  defaultReminderTime: number;
  syncWithDeviceCalendar: boolean;
}

type ViewMode = 'week' | 'day' | 'month' | 'agenda';
type StatusFilter = 'all' | 'upcoming' | 'live' | 'completed';
type SortType = 'time' | 'subject' | 'teacher';

const CACHE_KEY = 'schedule_settings';
const DEFAULT_SETTINGS: ScheduleSettings = {
  showWeekends: true,
  showDeadlines: true,
  defaultView: 'week',
  defaultReminderTime: 15,
  syncWithDeviceCalendar: false,
};

export default function NewScheduleScreen({ navigation: _navigation }: Props) {
  const { user } = useAuth();

  // Hamburger menu state
  const [menuVisible, setMenuVisible] = useState(false);

  // View and filter state
  const [viewMode, setViewMode] = useState<ViewMode>('week');
  const [statusFilter, setStatusFilter] = useState<StatusFilter>('all');
  const [selectedSubject, setSelectedSubject] = useState<string>('All');
  const [sortType, setSortType] = useState<SortType>('time');
  const [selectedDate, setSelectedDate] = useState(new Date());

  // Week navigation state
  const [weekStart, setWeekStart] = useState(() => {
    const today = new Date();
    const day = today.getDay();
    const diff = today.getDate() - day; // Start from Sunday
    return new Date(today.setDate(diff));
  });

  // Modal state
  const [showSortModal, setShowSortModal] = useState(false);
  const [showCalendarModal, setShowCalendarModal] = useState(false);
  const [showSettingsModal, setShowSettingsModal] = useState(false);

  // Settings state
  const [settings, setSettings] = useState<ScheduleSettings>(DEFAULT_SETTINGS);

  // Track screen view
  useEffect(() => {
    trackScreenView('NewScheduleScreen');
    loadSettings();
  }, []);

  // Load settings from AsyncStorage
  const loadSettings = useCallback(async () => {
    try {
      const cached = await AsyncStorage.getItem(CACHE_KEY);
      if (cached) {
        const parsedSettings = JSON.parse(cached);
        setSettings(parsedSettings);
        setViewMode(parsedSettings.defaultView);
        console.log('‚úÖ Loaded settings from cache');
      }
    } catch (error) {
      console.error('Failed to load settings:', error);
    }
  }, []);

  // Save settings to AsyncStorage
  const saveSettings = useCallback(async (newSettings: ScheduleSettings) => {
    try {
      await AsyncStorage.setItem(CACHE_KEY, JSON.stringify(newSettings));
      setSettings(newSettings);
      console.log('‚úÖ Settings saved to cache');
      Alert.alert('Success', 'Settings saved successfully!');
    } catch (error) {
      console.error('Failed to save settings:', error);
      Alert.alert('Error', 'Failed to save settings');
    }
  }, []);

  // Fetch classes for the week
  const { data: weekClasses, isLoading, error, refetch, isRefetching } = useQuery({
    queryKey: ['week-classes', user?.id, weekStart.toISOString()],
    queryFn: async () => {
      if (!user?.id) throw new Error('No user ID');

      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 7);

      const { data, error } = await supabase
        .from('class_sessions')
        .select('*, teachers(name)')
        .eq('student_id', user.id)
        .gte('scheduled_at', weekStart.toISOString())
        .lt('scheduled_at', weekEnd.toISOString())
        .order('scheduled_at', { ascending: true });

      if (error) throw error;

      // Group classes by day
      const days: DaySchedule[] = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);

        // Skip weekends if setting is off
        if (!settings.showWeekends && (date.getDay() === 0 || date.getDay() === 6)) {
          continue;
        }

        const dayClasses = (data || []).filter(cls => {
          const classDate = new Date(cls.scheduled_at);
          return classDate.toDateString() === date.toDateString();
        });

        days.push({
          date,
          dayName: date.toLocaleDateString('en-US', { weekday: 'long' }),
          dayShort: date.toLocaleDateString('en-US', { weekday: 'short' }),
          isToday: date.toDateString() === new Date().toDateString(),
          classes: dayClasses.map(cls => ({
            ...cls,
            teacher_name: (cls.teachers as any)?.name || 'Unknown Teacher',
          })),
        });
      }

      return days;
    },
    enabled: !!user?.id,
  });

  // Fetch student profile data for HamburgerMenu
  const { data: studentData } = useQuery({
    queryKey: ['student-profile-menu', user?.id],
    queryFn: async () => {
      if (!user?.id) return null;

      const { data, error } = await supabase
        .from('students')
        .select('name, grade, section, student_id')
        .eq('id', user.id)
        .single();

      if (error) {
        console.error('Error fetching student profile:', error);
        return null;
      }
      return data;
    },
    enabled: !!user?.id,
  });

  // Get unique subjects
  const subjects = useMemo(() => {
    if (!weekClasses) return ['All'];
    const allSubjects = new Set<string>();
    weekClasses.forEach(day =>
      day.classes.forEach(cls => allSubjects.add(cls.subject))
    );
    return ['All', ...Array.from(allSubjects)];
  }, [weekClasses]);

  // Get class status based on time
  const getClassStatus = (classSession: ClassSession): 'live' | 'upcoming' | 'ended' => {
    if (classSession.status === 'cancelled') return 'ended';
    if (classSession.status === 'completed') return 'ended';

    const now = new Date();
    const start = new Date(classSession.scheduled_at);
    const end = new Date(start.getTime() + classSession.duration_minutes * 60000);

    if (now >= start && now <= end) return 'live';
    if (now > end) return 'ended';
    return 'upcoming';
  };

  // Filter and sort classes
  const filteredWeekClasses = useMemo(() => {
    if (!weekClasses) return [];

    return weekClasses.map(day => {
      let filtered = day.classes;

      // Apply status filter
      if (statusFilter !== 'all') {
        filtered = filtered.filter(cls => {
          const status = getClassStatus(cls);
          if (statusFilter === 'upcoming') return status === 'upcoming';
          if (statusFilter === 'live') return status === 'live';
          if (statusFilter === 'completed') return status === 'ended';
          return true;
        });
      }

      // Apply subject filter
      if (selectedSubject !== 'All') {
        filtered = filtered.filter(cls => cls.subject === selectedSubject);
      }

      // Filter deadlines if setting is off
      if (!settings.showDeadlines) {
        filtered = filtered.filter(cls => !cls.is_deadline);
      }

      // Apply sorting
      const sorted = [...filtered].sort((a, b) => {
        switch (sortType) {
          case 'time':
            return new Date(a.scheduled_at).getTime() - new Date(b.scheduled_at).getTime();
          case 'subject':
            return a.subject.localeCompare(b.subject);
          case 'teacher':
            return a.teacher_name.localeCompare(b.teacher_name);
          default:
            return 0;
        }
      });

      return { ...day, classes: sorted };
    });
  }, [weekClasses, statusFilter, selectedSubject, sortType, settings.showDeadlines]);

  // Navigate to previous week
  const handlePreviousWeek = useCallback(() => {
    const newWeekStart = new Date(weekStart);
    newWeekStart.setDate(weekStart.getDate() - 7);
    setWeekStart(newWeekStart);
    trackAction('navigate_week', 'NewScheduleScreen', { direction: 'previous' });
  }, [weekStart]);

  // Navigate to next week
  const handleNextWeek = useCallback(() => {
    const newWeekStart = new Date(weekStart);
    newWeekStart.setDate(weekStart.getDate() + 7);
    setWeekStart(newWeekStart);
    trackAction('navigate_week', 'NewScheduleScreen', { direction: 'next' });
  }, [weekStart]);

  // Navigate to today
  const handleToday = useCallback(() => {
    const today = new Date();
    const day = today.getDay();
    const diff = today.getDate() - day;
    setWeekStart(new Date(today.setDate(diff)));
    setSelectedDate(new Date());
    trackAction('navigate_today', 'NewScheduleScreen');
  }, []);

  // Handle class press
  const handleClassPress = useCallback((classSession: ClassSession) => {
    trackAction('view_class_detail', 'NewScheduleScreen', { classId: classSession.id });

    Alert.alert(
      classSession.subject,
      `Teacher: ${classSession.teacher_name}\nTime: ${new Date(classSession.scheduled_at).toLocaleString()}\nDuration: ${classSession.duration_minutes} min${classSession.description ? `\n\n${classSession.description}` : ''}`,
      [
        { text: 'Cancel', style: 'cancel' },
        { text: 'View Details', onPress: () => safeNavigate('ClassDetail', { classId: classSession.id }) },
        ...(getClassStatus(classSession) === 'live'
          ? [{ text: 'Join Class', onPress: () => safeNavigate('LiveClass', { classId: classSession.id }) }]
          : []),
      ]
    );
  }, []);

  // Get priority emoji
  const getPriorityEmoji = (priority?: string) => {
    switch (priority) {
      case 'high':
        return 'üî¥';
      case 'medium':
        return 'üü°';
      case 'low':
        return 'üü¢';
      default:
        return '';
    }
  };

  // Get type emoji
  const getTypeEmoji = (isDeadline?: boolean) => {
    return isDeadline ? '‚è∞' : 'üìö';
  };

  // Render week view
  const renderWeekView = () => {
    if (!filteredWeekClasses || filteredWeekClasses.length === 0) {
      return (
        <View style={styles.emptyContainer}>
          <T variant="body">No classes scheduled this week</T>
        </View>
      );
    }

    return (
      <FlatList
        data={filteredWeekClasses}
        keyExtractor={(day) => day.date.toISOString()}
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.weekList}
        renderItem={({ item: day }) => (
          <Card variant="outlined" style={[styles.dayCard, day.isToday && styles.todayCard]}>
            {/* Day Header */}
            <CardHeader
              title={day.dayShort}
              subtitle={day.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
              trailing={
                day.isToday ? (
                  <Badge variant="info">TODAY</Badge>
                ) : undefined
              }
            />

            {/* Classes List */}
            <CardContent>
              {day.classes.length > 0 ? (
                <View style={styles.classesContainer}>
                  {day.classes.map((classSession) => {
                    const status = getClassStatus(classSession);
                    const time = new Date(classSession.scheduled_at);

                    return (
                      <TouchableOpacity
                        key={classSession.id}
                        style={styles.classItem}
                        onPress={() => handleClassPress(classSession)}
                        accessibilityRole="button"
                        accessibilityLabel={`${classSession.subject} class with ${classSession.teacher_name}`}
                        accessibilityHint="Double tap to view class details"
                      >
                        <View style={styles.classTime}>
                          <T variant="caption" weight="semiBold">
                            {time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}
                          </T>
                          <T variant="caption" style={styles.classDuration}>
                            {classSession.duration_minutes}min
                          </T>
                        </View>

                        <View style={styles.classInfo}>
                          <Row gap="xs" align="center" style={{ marginBottom: 4 }}>
                            <T variant="h3">{getTypeEmoji(classSession.is_deadline)}</T>
                            {classSession.priority && (
                              <T variant="h3">{getPriorityEmoji(classSession.priority)}</T>
                            )}
                            <T variant="body" weight="semiBold" numberOfLines={1} style={{ flex: 1 }}>
                              {classSession.subject}
                            </T>
                            <Badge
                              variant={status === 'live' ? 'error' : status === 'upcoming' ? 'success' : 'neutral'}
                            >
                              {status === 'live' ? 'üî¥ LIVE' : status === 'upcoming' ? '‚è∞' : '‚úÖ'}
                            </Badge>
                          </Row>
                          <T variant="caption" style={styles.classTeacher} numberOfLines={1}>
                            {classSession.teacher_name}
                          </T>
                        </View>
                      </TouchableOpacity>
                    );
                  })}
                </View>
              ) : (
                <View style={styles.noClassesContainer}>
                  <T variant="caption" style={styles.noClassesText}>
                    No classes scheduled
                  </T>
                </View>
              )}
            </CardContent>
          </Card>
        )}
      />
    );
  };

  // Render day view
  const renderDayView = () => {
    const selectedDay = filteredWeekClasses?.find(day =>
      day.date.toDateString() === selectedDate.toDateString()
    );

    if (!selectedDay) {
      return (
        <View style={styles.emptyContainer}>
          <T variant="body">No classes scheduled for this day</T>
        </View>
      );
    }

    return (
      <ScrollView style={styles.dayViewContainer} showsVerticalScrollIndicator={false}>
        <Card variant="outlined">
          <CardHeader
            title={selectedDay.dayName}
            subtitle={selectedDay.date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
          />
          <CardContent>
            {selectedDay.classes.length > 0 ? (
              <View style={styles.classesContainer}>
                {selectedDay.classes.map((classSession) => {
                  const status = getClassStatus(classSession);
                  const time = new Date(classSession.scheduled_at);

                  return (
                    <Card key={classSession.id} variant="filled" style={{ marginBottom: 12 }}>
                      <CardContent>
                        <TouchableOpacity onPress={() => handleClassPress(classSession)}>
                          <Row gap="xs" align="center" style={{ marginBottom: 8 }}>
                            <T variant="h2">{getTypeEmoji(classSession.is_deadline)}</T>
                            {classSession.priority && (
                              <T variant="h2">{getPriorityEmoji(classSession.priority)}</T>
                            )}
                            <Col style={{ flex: 1 }}>
                              <T variant="body" weight="bold">
                                {classSession.subject}
                              </T>
                              <T variant="caption" color="textSecondary">
                                {classSession.teacher_name}
                              </T>
                            </Col>
                            <Badge
                              variant={status === 'live' ? 'error' : status === 'upcoming' ? 'success' : 'neutral'}
                            >
                              {status === 'live' ? 'LIVE' : status === 'upcoming' ? 'UPCOMING' : 'ENDED'}
                            </Badge>
                          </Row>
                          <Row gap="md">
                            <T variant="caption">
                              üïê {time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}
                            </T>
                            <T variant="caption">
                              ‚è±Ô∏è {classSession.duration_minutes} min
                            </T>
                          </Row>
                          {classSession.description && (
                            <>
                              <Spacer size="sm" />
                              <T variant="caption" color="textSecondary">
                                {classSession.description}
                              </T>
                            </>
                          )}
                        </TouchableOpacity>
                      </CardContent>
                    </Card>
                  );
                })}
              </View>
            ) : (
              <T variant="body" color="textSecondary" style={{ textAlign: 'center', padding: 24 }}>
                No classes scheduled for this day
              </T>
            )}
          </CardContent>
        </Card>
      </ScrollView>
    );
  };

  // Render month view
  const renderMonthView = () => {
    const monthStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
    const monthEnd = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0);
    const startDate = new Date(monthStart);
    startDate.setDate(startDate.getDate() - monthStart.getDay());

    const days = [];
    const currentDate = new Date(startDate);

    while (currentDate <= monthEnd || currentDate.getDay() !== 0) {
      days.push(new Date(currentDate));
      currentDate.setDate(currentDate.getDate() + 1);
    }

    return (
      <ScrollView style={styles.monthContainer} showsVerticalScrollIndicator={false}>
        <Card variant="outlined">
          <CardHeader
            title={selectedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
          />
          <CardContent>
            {/* Weekday headers */}
            <Row gap="xs" style={{ marginBottom: 8 }}>
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <View key={day} style={styles.monthDayHeader}>
                  <T variant="caption" weight="semiBold" style={{ textAlign: 'center' }}>
                    {day}
                  </T>
                </View>
              ))}
            </Row>

            {/* Calendar grid */}
            <View style={styles.monthGrid}>
              {days.map((day, index) => {
                const dateStr = day.toDateString();
                const isToday = dateStr === new Date().toDateString();
                const isCurrentMonth = day.getMonth() === selectedDate.getMonth();

                // Find classes for this day
                const daySchedule = filteredWeekClasses?.find(
                  d => d.date.toDateString() === dateStr
                );
                const hasClasses = daySchedule && daySchedule.classes.length > 0;
                const hasDeadlines = daySchedule?.classes.some(c => c.is_deadline);

                return (
                  <TouchableOpacity
                    key={index}
                    style={[
                      styles.monthDay,
                      isToday && styles.monthDayToday,
                      !isCurrentMonth && styles.monthDayOther,
                    ]}
                    onPress={() => {
                      setSelectedDate(day);
                      setViewMode('day');
                      trackAction('select_day', 'NewScheduleScreen', { date: day.toISOString() });
                    }}
                    accessibilityRole="button"
                    accessibilityLabel={`${day.toLocaleDateString()}, ${hasClasses ? `${daySchedule.classes.length} classes` : 'no classes'}`}
                  >
                    <T
                      variant="caption"
                      weight={isToday ? 'bold' : 'regular'}
                      style={[
                        styles.monthDayText,
                        isToday && styles.monthDayTodayText,
                        !isCurrentMonth && styles.monthDayOtherText,
                      ]}
                    >
                      {day.getDate()}
                    </T>
                    {hasClasses && (
                      <Row gap="xs" style={styles.monthDayIndicators}>
                        {hasDeadlines && <View style={[styles.eventDot, { backgroundColor: '#EF4444' }]} />}
                        {daySchedule.classes.filter(c => !c.is_deadline).length > 0 && (
                          <View style={[styles.eventDot, { backgroundColor: '#3B82F6' }]} />
                        )}
                      </Row>
                    )}
                  </TouchableOpacity>
                );
              })}
            </View>
          </CardContent>
        </Card>
      </ScrollView>
    );
  };

  // Render agenda view
  const renderAgendaView = () => {
    const allClasses = filteredWeekClasses?.flatMap(day =>
      day.classes.map(cls => ({ ...cls, date: day.date }))
    ) || [];

    return (
      <ScrollView style={styles.agendaContainer} showsVerticalScrollIndicator={false}>
        {allClasses.length > 0 ? (
          allClasses.map((classSession, index) => {
            const status = getClassStatus(classSession);
            const time = new Date(classSession.scheduled_at);

            return (
              <Card key={`${classSession.id}-${index}`} variant="outlined" style={{ marginBottom: 12 }}>
                <CardContent>
                  <TouchableOpacity onPress={() => handleClassPress(classSession)}>
                    <Row gap="sm" align="center" style={{ marginBottom: 8 }}>
                      <T variant="h2">{getTypeEmoji(classSession.is_deadline)}</T>
                      {classSession.priority && (
                        <T variant="h2">{getPriorityEmoji(classSession.priority)}</T>
                      )}
                      <Col style={{ flex: 1 }}>
                        <T variant="body" weight="bold">
                          {classSession.subject}
                        </T>
                        <T variant="caption" color="textSecondary">
                          {classSession.teacher_name}
                        </T>
                      </Col>
                      <Badge
                        variant={status === 'live' ? 'error' : status === 'upcoming' ? 'success' : 'neutral'}
                      >
                        {status === 'live' ? 'LIVE' : status === 'upcoming' ? 'UPCOMING' : 'ENDED'}
                      </Badge>
                    </Row>
                    <Row gap="md">
                      <T variant="caption">
                        üìÖ {(classSession as any).date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                      </T>
                      <T variant="caption">
                        üïê {time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}
                      </T>
                      <T variant="caption">
                        ‚è±Ô∏è {classSession.duration_minutes} min
                      </T>
                    </Row>
                  </TouchableOpacity>
                </CardContent>
              </Card>
            );
          })
        ) : (
          <Card variant="outlined">
            <CardContent>
              <T variant="body" color="textSecondary" style={{ textAlign: 'center', padding: 24 }}>
                No classes in agenda
              </T>
            </CardContent>
          </Card>
        )}
      </ScrollView>
    );
  };

  return (
    <SafeAreaView style={styles.safeArea}>
      {/* Hamburger Menu */}
      <HamburgerMenu
        visible={menuVisible}
        onClose={() => setMenuVisible(false)}
        currentRoute="NewScheduleScreen"
        studentData={studentData || undefined}
      />

      {/* Top Bar */}
      <View style={styles.topBar}>
        <TouchableOpacity
          style={styles.iconButton}
          onPress={() => {
            trackAction('open_menu', 'NewScheduleScreen');
            setMenuVisible(true);
          }}
          accessibilityRole="button"
          accessibilityLabel="Open menu"
        >
          <T variant="h2" style={styles.icon}>‚ò∞</T>
        </TouchableOpacity>

        <T variant="body" weight="bold" style={styles.topBarTitle}>
          Schedule
        </T>

        <TouchableOpacity
          style={styles.iconButton}
          onPress={() => setShowSettingsModal(true)}
          accessibilityRole="button"
          accessibilityLabel="Settings"
        >
          <T variant="h2" style={styles.icon}>‚öôÔ∏è</T>
        </TouchableOpacity>
      </View>

      <BaseScreen
        scrollable={false}
        loading={isLoading && !isRefetching}
        error={error ? 'Failed to load schedule' : null}
        empty={!weekClasses || weekClasses.length === 0}
        emptyMessage="No classes scheduled"
        onRefresh={refetch}
      >
      {/* Week Navigation */}
      <View style={styles.navigation}>
        <TouchableOpacity
          onPress={handlePreviousWeek}
          style={styles.navButton}
          accessibilityRole="button"
          accessibilityLabel="Previous week"
        >
          <T variant="body" weight="semiBold" style={styles.navButtonText}>
            ‚Üê
          </T>
        </TouchableOpacity>

        <TouchableOpacity
          onPress={handleToday}
          style={styles.todayButton}
          accessibilityRole="button"
          accessibilityLabel="Go to today"
        >
          <T variant="body" weight="semiBold">
            {weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {' '}
            {new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
          </T>
        </TouchableOpacity>

        <TouchableOpacity
          onPress={handleNextWeek}
          style={styles.navButton}
          accessibilityRole="button"
          accessibilityLabel="Next week"
        >
          <T variant="body" weight="semiBold" style={styles.navButtonText}>
            ‚Üí
          </T>
        </TouchableOpacity>
      </View>

      {/* View Mode Toggle */}
      <View style={styles.viewToggle}>
        <Chip
          variant="filter"
          label="Week"
          selected={viewMode === 'week'}
          onPress={() => {
            setViewMode('week');
            trackAction('switch_view', 'NewScheduleScreen', { view: 'week' });
          }}
        />
        <Chip
          variant="filter"
          label="Day"
          selected={viewMode === 'day'}
          onPress={() => {
            setViewMode('day');
            trackAction('switch_view', 'NewScheduleScreen', { view: 'day' });
          }}
        />
        <Chip
          variant="filter"
          label="Month"
          selected={viewMode === 'month'}
          onPress={() => {
            setViewMode('month');
            trackAction('switch_view', 'NewScheduleScreen', { view: 'month' });
          }}
        />
        <Chip
          variant="filter"
          label="Agenda"
          selected={viewMode === 'agenda'}
          onPress={() => {
            setViewMode('agenda');
            trackAction('switch_view', 'NewScheduleScreen', { view: 'agenda' });
          }}
        />
      </View>

      {/* Filters and Controls */}
      <ScrollView
        horizontal
        showsHorizontalScrollIndicator={false}
        contentContainerStyle={styles.filtersContainer}
      >
        {/* Status Filter */}
        <Chip
          variant="filter"
          label="All"
          selected={statusFilter === 'all'}
          onPress={() => {
            setStatusFilter('all');
            trackAction('filter_status', 'NewScheduleScreen', { status: 'all' });
          }}
        />
        <Chip
          variant="filter"
          label="‚è∞ Upcoming"
          selected={statusFilter === 'upcoming'}
          onPress={() => {
            setStatusFilter('upcoming');
            trackAction('filter_status', 'NewScheduleScreen', { status: 'upcoming' });
          }}
        />
        <Chip
          variant="filter"
          label="üî¥ Live"
          selected={statusFilter === 'live'}
          onPress={() => {
            setStatusFilter('live');
            trackAction('filter_status', 'NewScheduleScreen', { status: 'live' });
          }}
        />
        <Chip
          variant="filter"
          label="‚úÖ Completed"
          selected={statusFilter === 'completed'}
          onPress={() => {
            setStatusFilter('completed');
            trackAction('filter_status', 'NewScheduleScreen', { status: 'completed' });
          }}
        />

        {/* Subject Filter */}
        {subjects.map(subject => (
          <Chip
            key={subject}
            variant="filter"
            label={subject}
            selected={selectedSubject === subject}
            onPress={() => {
              setSelectedSubject(subject);
              trackAction('filter_subject', 'NewScheduleScreen', { subject });
            }}
          />
        ))}

        {/* Sort Button */}
        <Chip
          variant="assist"
          label={`Sort: ${sortType}`}
          onPress={() => setShowSortModal(true)}
        />

        {/* Calendar Button */}
        <Chip
          variant="assist"
          label="üìÖ Calendar"
          onPress={() => setShowCalendarModal(true)}
        />

        {/* Settings Button */}
        <Chip
          variant="assist"
          label="‚öôÔ∏è Settings"
          onPress={() => setShowSettingsModal(true)}
        />
      </ScrollView>

      {/* Content */}
      <View style={{ flex: 1 }}>
        {viewMode === 'week' && renderWeekView()}
        {viewMode === 'day' && renderDayView()}
        {viewMode === 'month' && renderMonthView()}
        {viewMode === 'agenda' && renderAgendaView()}
      </View>

      {/* Sort Modal */}
      <Modal visible={showSortModal} transparent animationType="slide">
        <View style={styles.modalOverlay}>
          <Card style={styles.modal}>
            <CardHeader
              title="Sort By"
              trailing={
                <TouchableOpacity onPress={() => setShowSortModal(false)}>
                  <T variant="body" weight="bold" style={{ color: '#6B7280' }}>
                    ‚úï
                  </T>
                </TouchableOpacity>
              }
            />
            <CardContent>
              <Button
                variant={sortType === 'time' ? 'primary' : 'ghost'}
                fullWidth
                onPress={() => {
                  setSortType('time');
                  setShowSortModal(false);
                  trackAction('change_sort', 'NewScheduleScreen', { sort: 'time' });
                }}
              >
                üïê Time
              </Button>
              <Spacer size="sm" />
              <Button
                variant={sortType === 'subject' ? 'primary' : 'ghost'}
                fullWidth
                onPress={() => {
                  setSortType('subject');
                  setShowSortModal(false);
                  trackAction('change_sort', 'NewScheduleScreen', { sort: 'subject' });
                }}
              >
                üìö Subject
              </Button>
              <Spacer size="sm" />
              <Button
                variant={sortType === 'teacher' ? 'primary' : 'ghost'}
                fullWidth
                onPress={() => {
                  setSortType('teacher');
                  setShowSortModal(false);
                  trackAction('change_sort', 'NewScheduleScreen', { sort: 'teacher' });
                }}
              >
                üë®‚Äçüè´ Teacher
              </Button>
            </CardContent>
          </Card>
        </View>
      </Modal>

      {/* Calendar Picker Modal */}
      <Modal visible={showCalendarModal} transparent animationType="slide">
        <View style={styles.modalOverlay}>
          <Card style={styles.modal}>
            <CardHeader
              title="Select Date"
              trailing={
                <TouchableOpacity onPress={() => setShowCalendarModal(false)}>
                  <T variant="body" weight="bold" style={{ color: '#6B7280' }}>
                    ‚úï
                  </T>
                </TouchableOpacity>
              }
            />
            <CardContent>
              <T variant="body" style={{ marginBottom: 16 }}>
                Current: {selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
              </T>
              <Button
                variant="primary"
                fullWidth
                onPress={() => {
                  setSelectedDate(new Date());
                  setViewMode('day');
                  setShowCalendarModal(false);
                  trackAction('select_today', 'NewScheduleScreen');
                }}
              >
                üìÖ Go to Today
              </Button>
              <Spacer size="sm" />
              <T variant="caption" color="textSecondary" style={{ textAlign: 'center' }}>
                Tip: Use Month view to select specific dates
              </T>
            </CardContent>
          </Card>
        </View>
      </Modal>

      {/* Settings Modal */}
      <Modal visible={showSettingsModal} transparent animationType="slide">
        <View style={styles.modalOverlay}>
          <ScrollView contentContainerStyle={styles.scrollModalContent}>
            <Card style={styles.settingsModal}>
              <CardHeader
                title="Schedule Settings"
                trailing={
                  <TouchableOpacity onPress={() => setShowSettingsModal(false)}>
                    <T variant="body" weight="bold" style={{ color: '#6B7280' }}>
                      ‚úï
                    </T>
                  </TouchableOpacity>
                }
              />
              <CardContent>
                {/* Show Weekends */}
                <View style={styles.settingRow}>
                  <Col style={{ flex: 1 }}>
                    <T variant="body" weight="semiBold">
                      Show Weekends
                    </T>
                    <T variant="caption" color="textSecondary">
                      Display Saturday and Sunday in schedule
                    </T>
                  </Col>
                  <Switch
                    value={settings.showWeekends}
                    onValueChange={(value) =>
                      setSettings(prev => ({ ...prev, showWeekends: value }))
                    }
                  />
                </View>

                <Spacer size="md" />

                {/* Show Deadlines */}
                <View style={styles.settingRow}>
                  <Col style={{ flex: 1 }}>
                    <T variant="body" weight="semiBold">
                      Show Deadlines
                    </T>
                    <T variant="caption" color="textSecondary">
                      Include assignment deadlines in schedule
                    </T>
                  </Col>
                  <Switch
                    value={settings.showDeadlines}
                    onValueChange={(value) =>
                      setSettings(prev => ({ ...prev, showDeadlines: value }))
                    }
                  />
                </View>

                <Spacer size="md" />

                {/* Default View */}
                <View>
                  <T variant="body" weight="semiBold" style={{ marginBottom: 8 }}>
                    Default View
                  </T>
                  <Row gap="xs" wrap>
                    {(['week', 'day', 'month', 'agenda'] as ViewMode[]).map(view => (
                      <Chip
                        key={view}
                        variant="filter"
                        label={view.charAt(0).toUpperCase() + view.slice(1)}
                        selected={settings.defaultView === view}
                        onPress={() =>
                          setSettings(prev => ({ ...prev, defaultView: view }))
                        }
                      />
                    ))}
                  </Row>
                </View>

                <Spacer size="md" />

                {/* Default Reminder Time */}
                <View>
                  <T variant="body" weight="semiBold" style={{ marginBottom: 8 }}>
                    Default Reminder (minutes before)
                  </T>
                  <Row gap="xs" wrap>
                    {[5, 10, 15, 30, 60].map(minutes => (
                      <Chip
                        key={minutes}
                        variant="filter"
                        label={`${minutes}min`}
                        selected={settings.defaultReminderTime === minutes}
                        onPress={() =>
                          setSettings(prev => ({ ...prev, defaultReminderTime: minutes }))
                        }
                      />
                    ))}
                  </Row>
                </View>

                <Spacer size="md" />

                {/* Sync with Device Calendar */}
                <View style={styles.settingRow}>
                  <Col style={{ flex: 1 }}>
                    <T variant="body" weight="semiBold">
                      Sync with Device Calendar
                    </T>
                    <T variant="caption" color="textSecondary">
                      Export classes to your device calendar
                    </T>
                  </Col>
                  <Switch
                    value={settings.syncWithDeviceCalendar}
                    onValueChange={(value) => {
                      setSettings(prev => ({ ...prev, syncWithDeviceCalendar: value }));
                      if (value) {
                        Alert.alert(
                          'Calendar Sync',
                          'Calendar sync enabled. Classes will be exported to your device calendar.',
                          [{ text: 'OK' }]
                        );
                      }
                    }}
                  />
                </View>
              </CardContent>

              <CardActions>
                <Button
                  variant="ghost"
                  onPress={() => {
                    setSettings(DEFAULT_SETTINGS);
                    trackAction('reset_settings', 'NewScheduleScreen');
                  }}
                >
                  Reset
                </Button>
                <Button
                  variant="primary"
                  onPress={() => {
                    saveSettings(settings);
                    setShowSettingsModal(false);
                    refetch();
                    trackAction('save_settings', 'NewScheduleScreen');
                  }}
                >
                  Save Settings
                </Button>
              </CardActions>
            </Card>
          </ScrollView>
        </View>
      </Modal>
      </BaseScreen>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: '#F8F9FA',
  },
  topBar: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    paddingVertical: 12,
    backgroundColor: '#FFFFFF',
    borderBottomWidth: 1,
    borderBottomColor: '#E5E7EB',
  },
  iconButton: {
    width: 48,
    height: 48,
    alignItems: 'center',
    justifyContent: 'center',
  },
  icon: {
    fontSize: 24,
    color: '#111827',
  },
  topBarTitle: {
    fontSize: 18,
    color: '#111827',
  },
  navigation: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    paddingVertical: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#E5E7EB',
  },
  navButton: {
    width: 48,
    height: 48,
    alignItems: 'center',
    justifyContent: 'center',
  },
  navButtonText: {
    fontSize: 24,
    color: '#3B82F6',
  },
  todayButton: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    paddingHorizontal: 16,
  },
  viewToggle: {
    flexDirection: 'row',
    marginHorizontal: 16,
    marginTop: 12,
    gap: 8,
  },
  filtersContainer: {
    paddingHorizontal: 16,
    paddingVertical: 12,
    gap: 8,
  },
  weekList: {
    padding: 16,
    gap: 16,
  },
  dayCard: {
    marginBottom: 0,
  },
  todayCard: {
    borderWidth: 2,
    borderColor: '#3B82F6',
  },
  classesContainer: {
    gap: 12,
  },
  classItem: {
    flexDirection: 'row',
    gap: 12,
    minHeight: 48,
  },
  classTime: {
    width: 70,
    alignItems: 'flex-end',
    justifyContent: 'center',
  },
  classDuration: {
    color: '#9CA3AF',
  },
  classInfo: {
    flex: 1,
    justifyContent: 'center',
  },
  classTeacher: {
    color: '#6B7280',
  },
  noClassesContainer: {
    alignItems: 'center',
    paddingVertical: 16,
  },
  noClassesText: {
    color: '#9CA3AF',
    fontStyle: 'italic',
  },
  dayViewContainer: {
    padding: 16,
  },
  monthContainer: {
    padding: 16,
  },
  monthDayHeader: {
    flex: 1,
    paddingVertical: 8,
  },
  monthGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
  },
  monthDay: {
    width: '14.28%',
    aspectRatio: 1,
    justifyContent: 'center',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#E5E7EB',
  },
  monthDayToday: {
    backgroundColor: '#DBEAFE',
    borderColor: '#3B82F6',
  },
  monthDayOther: {
    opacity: 0.3,
  },
  monthDayText: {
    fontSize: 14,
  },
  monthDayTodayText: {
    color: '#3B82F6',
    fontWeight: 'bold',
  },
  monthDayOtherText: {
    color: '#9CA3AF',
  },
  monthDayIndicators: {
    marginTop: 2,
  },
  eventDot: {
    width: 6,
    height: 6,
    borderRadius: 3,
  },
  agendaContainer: {
    padding: 16,
  },
  emptyContainer: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    padding: 24,
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 16,
  },
  modal: {
    width: '100%',
    maxWidth: 400,
  },
  settingsModal: {
    width: '100%',
    maxWidth: 500,
    maxHeight: '80%',
  },
  scrollModalContent: {
    flexGrow: 1,
    justifyContent: 'center',
    padding: 16,
  },
  settingRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 12,
  },
});
